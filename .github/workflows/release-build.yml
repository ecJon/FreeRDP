name: 'Multi-Platform Release Build'

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v3.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: ubuntu-latest
    name: 'Build Windows (MinGW)'
    continue-on-error: true
    steps:
      - name: 'Checkout source'
        uses: actions/checkout@v4

      - name: 'Prepare environment'
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y \
            git \
            nasm \
            meson \
            cmake \
            ninja-build \
            mingw-w64 \
            mingw-w64-tools \
            binutils-mingw-w64

      - name: 'Run MinGW shared build'
        run: |
          ./scripts/mingw.sh

      - name: 'Create Windows archive'
        run: |
          cd build-mingw/install
          zip -r ../../FreeRDP-Windows-x64.zip *
          cd ../..

      - name: 'Upload Windows artifact'
        uses: actions/upload-artifact@v4
        with:
          name: FreeRDP-Windows-x64
          path: FreeRDP-Windows-x64.zip
          retention-days: 7

  build-macos:
    runs-on: macos-latest
    name: 'Build macOS'
    continue-on-error: true
    steps:
      - name: 'Checkout source'
        uses: actions/checkout@v4

      - name: 'Prepare environment'
        run: |
          brew install autoconf automake git libtool meson

      - name: 'Run macOS build'
        run: |
          ./scripts/bundle-mac-os.sh

      - name: 'Create macOS archive'
        run: |
          cd install
          zip -r ../FreeRDP-macOS-universal.zip MacFreeRDP.app
          cd ..

      - name: 'Upload macOS artifact'
        uses: actions/upload-artifact@v4
        with:
          name: FreeRDP-macOS-universal
          path: FreeRDP-macOS-universal.zip
          retention-days: 7

  build-linux:
    runs-on: ubuntu-latest
    name: 'Build Linux'
    continue-on-error: true
    steps:
      - name: 'Checkout source'
        uses: actions/checkout@v4

      - name: 'Prepare environment'
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y \
            cmake \
            ninja-build \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libxfixes-dev \
            libxi-dev \
            libxtst-dev \
            libxv-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxinerama-dev \
            libssl-dev \
            libpulse-dev \
            libusb-1.0-0-dev \
            liburiparser-dev \
            libjson-c-dev \
            libsdl2-dev \
            libsdl2-ttf-dev \
            libavcodec-dev \
            libavutil-dev \
            libswscale-dev \
            libopus-dev \
            libfdk-aac-dev \
            libopenh264-dev \
            libcairo2-dev \
            libcups2-dev \
            libfuse3-dev \
            libglib2.0-dev \
            libpam0g-dev \
            libkrb5-dev

      - name: 'Build FreeRDP'
        run: |
          mkdir -p build
          cd build
          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DWITH_MANPAGES=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DWITH_PLATFORM_SERVER=OFF \
            -DWITH_CLIENT_SDL2=ON \
            -DWITH_SIMD=ON \
            -DWITH_FFMPEG=ON \
            -DWITH_OPENH264=ON \
            -DWITH_OPUS=ON \
            -DWITH_FDK_AAC=ON \
            -DWITH_JSONC_REQUIRED=ON \
            ..
          ninja -j$(nproc)
          ninja install

      - name: 'Create Linux archive'
        run: |
          cd install
          tar -czf ../FreeRDP-Linux-x64.tar.gz *
          cd ..

      - name: 'Upload Linux artifact'
        uses: actions/upload-artifact@v4
        with:
          name: FreeRDP-Linux-x64
          path: FreeRDP-Linux-x64.tar.gz
          retention-days: 7

  create-release:
    needs: [build-windows, build-macos, build-linux]
    if: always()
    runs-on: ubuntu-latest
    name: 'Create GitHub Release'
    permissions:
      contents: write
    steps:
      - name: 'Checkout source'
        uses: actions/checkout@v4

      - name: 'Download Windows artifact'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: FreeRDP-Windows-x64
          path: ./artifacts

      - name: 'Download macOS artifact'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: FreeRDP-macOS-universal
          path: ./artifacts

      - name: 'Download Linux artifact'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: FreeRDP-Linux-x64
          path: ./artifacts

      - name: 'List all artifacts'
        run: ls -laR ./artifacts

      - name: 'Create Release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: FreeRDP ${{ inputs.tag }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            artifacts/FreeRDP-Windows-x64.zip
            artifacts/FreeRDP-macOS-universal.zip
            artifacts/FreeRDP-Linux-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
